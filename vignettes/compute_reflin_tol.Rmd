---
title: "test"
author: "John Minter"
date: 'Started 2018-08-24, Last modified: 2018-08-26'
output:
  html_document:
    css: ../inc/jm.css
    number_sections: yes
    toc: yes
abstract: |
  The objective was to analyze the PENEPMA16 output from the example
  simulation `Al-100nm-on-Fe`
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE,
  comment = NA,
  fig.align = "centre",
  fig.height = 4,
  message = FALSE,
  warning = FALSE,
  error = FALSE)
```

# Set up for the analysis

**Note**: This simulation used a `REFLIN` parameter of 5.0E-1 using
the line

```
REFLIN 26010400 1 5.E-1      [Fe K-L3 IZ*1e6+S1*1e4+S2*1e2,dete,tol.]
```

First load the libraries we need...

```{r loadPackages}
library(rpenepma)
library(dplyr)
library(pander)
panderOptions('table.split.table', Inf)
library(ggplot2)
library(here)
library(DescTools)
```

Next, set the paths and constants that we need...

```{r setPaths}
e0          <- 20 # kV
sim_dir     <- here()
sim_nam     <- "Al-100nm-on-Fe"
unc_csv     <- sprintf("%s/%s-%gkV_reflin.csv", sim_dir, sim_nam,e0)
res_fi      <- sprintf("%s/penepma-res.dat", sim_dir)
int_fi      <- sprintf("%s/pe-intens-01.dat", sim_dir)
spc_fi      <- sprintf("%s/pe-spect-01.dat", sim_dir)
out_ti      <- sprintf("%s-%gkV", sim_nam, e0)
msa_fi      <- sprintf("%s/%s-%gkV.msa", sim_dir, sim_nam, e0)
print(unc_csv)
```


# Get the current simulation parameters

```{r calcSimTime}


sim_par <- penepma16_get_time_traj_uncert(sim_dir)
print(sim_par)
```

# Retrieve the number of showers

We want retrieve the number of showers (trajectories) that our `penepma16`
simulation calculated.

```{r calcNumShowers}
num_showers <- Format(sim_par$num_traj, digits=3, sci=c(1, 10))
cat("Number of trajectories: ", num_showers)
```

# Compute the total maximum intensity for each element

## Retrieve the data

First retrieve the intensity data as a `tibble` and print a preview.

```{r LoadMaxIntensity}
int_tib <- penepma_get_intensities(int_fi)
# print(int_tib)
```

What features did we measure?

```{r listFeatures}
print(names(int_tib))
```

How many transitions did we measure?

```{r calcNumTrans}
print(nrow(int_tib))
```

Measure our test transition ("Fe K-L3")

```{r measureZnTrans}
val <- penepma_get_total_intensity_z_transition(int_tib, 26, "K", "L3")
print(val)
```

## Compute the maximum total intensity for each element

1. Compute the maximum total intensity for each element.
2. Stack each row of data together into a tibble.
3. Prepend the sample ID to the data.
4. Print a well-formatted a table using `pander`.
5. Save the final tibble so it can be r-loaded later

```{r calcNaxTotIntensity}
# 1
Cu_t   <- penepma_get_max_total_intensity_z(int_tib, 29)
Fe_t   <- penepma_get_max_total_intensity_z(int_tib, 26)
# 2
tot_int <- dplyr::bind_rows(Cu_t, Fe_t)
#3 
Al_100nm_on_Fe_max_it <- prepend_sample_id_max_int_tib(tot_int, out_ti)
# 4
pander(Al_100nm_on_Fe_max_it)
# 5
save(Al_100nm_on_Fe_max_it,
     file="Al_100nm_on_Fe_max_it.rda")
# delete and reload be sure it worked...
rm(Al_100nm_on_Fe_max_it)
load("./Al_100nm_on_Fe_max_it.rda")
```

# Process the spectra data

## Load the raw data

```{r loadSpectraData}
spc <- penepma_read_raw_data(spc_fi)
rownames(spc) <- c()
```

## Summarize the spectrum data

How many rows of data are there?

```{r cat_num_rows}
cat(c("Number of measurements: ", nrow(spc)))
```

Generate a summary:

```{r summarizeSpectrum}
pander(summary(spc))
```

## Plot the spectrum.

Start with a log-intensity plot.


```{r plotLogIntensSpectrum, fig.width=8, warning=FALSE}

plt <- ggplot(spc, aes(x = keV, y = pd.mu)) +
       geom_line() + 
       scale_x_continuous() +
       scale_y_log10() + # limits = c(int_lo_lim, m_t)) +
       xlab(label="X-ray energy [keV]") +
       ylab(label="log(probability density)") +
       # (1/(eV*sr*electron)") +
       ggtitle(out_ti) +
       theme(axis.text=element_text(size=12),
             axis.title=element_text(size=12),
             # center the title
             plot.title = element_text(hjust = 0.5))
       
print(plt)
```
And then on a linear intensity scale...

```{r plotLinIntensSpectrum, fig.width=8, warning=FALSE}

plt <- ggplot(spc, aes(x = keV, y = pd.mu)) +
       geom_line() + 
       scale_x_continuous() +
       scale_y_continuous() +
       xlab(label="X-ray energy [keV]") +
       ylab(label="Probability density") +
       # (1/(eV*sr*electron)") +
       ggtitle(out_ti) +
       theme(axis.text=element_text(size=12),
             axis.title=element_text(size=12),
             # center the title
             plot.title = element_text(hjust = 0.5))
       
print(plt)
```

## Write a spectrum file in MSA format

```{r writeMsa}
penepma_to_msa(spc_fi, msa_fi,e0, out_ti)
```

## Analyze the uncertainty data

```{r anaUncData}
unc_data <- tibble::as_tibble(read.csv(unc_csv))
head(unc_data)
```

Note the default smooth does not fit well. See the
[analyze_reflin_stats](analyze_reflin_stats.html) file for a better fit.

```{r plotUncData}
unc_plt <- ggplot(unc_data, aes(x = sim_time_sec, y = rel_unc)) +
           geom_point() +
           geom_smooth() + 
           scale_x_continuous() +
           scale_y_continuous() +
           xlab(label="simulation time [sec]") +
           ylab(label="relative uncertainty") +
           # (1/(eV*sr*electron)") +
           ggtitle(out_ti) +
           theme(axis.text=element_text(size=12),
                 axis.title=element_text(size=12),
                 # center the title
                 plot.title = element_text(hjust = 0.5))

print(unc_plt)
```
